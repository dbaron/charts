<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>Milestone Burndown</title>
	<script type="text/javascript">function importScript(dep, func){if (func!==undefined) func();}</script>
	<script type="text/javascript" src="modevlib/Settings.js"></script>
	<script type="text/javascript" src="modevlib/MozillaPrograms.js"></script>
	<script type="text/javascript" src="modevlib/rest/BugzillaClient.js"></script>
	<script type="text/javascript" src="modevlib/util/aUtil.js"></script>
	<script type="text/javascript" src="modevlib/util/aParse.js"></script>
	<script type="text/javascript" src="modevlib/collections/aMatrix.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.aggregate.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.column.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.cube.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.analytic.js"></script>
	<script type="text/javascript" src="modevlib/math/aMath.js"></script>
	<script type="text/javascript" src="modevlib/gui/Filter.js"></script>
	<script type="text/javascript" src="modevlib/gui/ComponentFilter.js"></script>
	<script type="text/javascript" src="modevlib/gui/PartitionFilter.js"></script>
	<script type="text/javascript" src="modevlib/qb/aCompiler.js"></script>
	<script type="text/javascript" src="modevlib/collections/aRelation.js"></script>
	<script type="text/javascript" src="modevlib/util/aString.js"></script>
	<script type="text/javascript" src="modevlib/util/aHTML.js"></script>
	<script type="text/javascript" src="modevlib/collections/aArray.js"></script>
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="modevlib/util/CNV.js"></script>
	<script type="text/javascript" src="modevlib/util/aDate.js"></script>
	<script type="text/javascript" src="modevlib/collections/aQueue.js"></script>
	<script type="text/javascript" src="modevlib/collections/aSet.js"></script>
	<script type="text/javascript" src="modevlib/util/aTemplate.js"></script>
	<script type="text/javascript" src="lib/jquery.numberformatter.js"></script>
	<script type="text/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
	<script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>
	<script type="text/javascript" src="modevlib/debug/aException.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.domain.js"></script>
	<script type="text/javascript" src="modevlib/util/aDuration.js"></script>
	<script type="text/javascript" src="lib/ccc/lib/protovis-d3.3.js"></script>
	<script type="text/javascript" src="modevlib/aFormat.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css"/>
	<script type="text/javascript" src="modevlib/gui/TeamFilter.js"></script>
	<script type="text/javascript" src="lib/ccc/lib/protovis-msie.js"></script>
	<script type="text/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>
	<script type="text/javascript" src="modevlib/debug/aLog.js"></script>
	<script type="text/javascript" src="lib/ccc/lib/jquery.tipsy.js"></script>
	<script type="text/javascript" src="modevlib/threads/thread.js"></script>
	<script type="text/javascript" src="modevlib/gui/ProgramFilter.js"></script>
	<script type="text/javascript" src="modevlib/gui/RadioFilter.js"></script>
	<script type="text/javascript" src="modevlib/util/aTimer.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css"/>
	<script type="text/javascript" src="lib/ccc/lib/tipsy.js"></script>
	<script type="text/javascript" src="modevlib/rest/Rest.js"></script>
	<script type="text/javascript" src="modevlib/aLibrary.js"></script>
	<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/ccc/lib/tipsy.css"/>
	<script type="text/javascript" src="modevlib/rest/ElasticSearch.js"></script>
	<script type="text/javascript" src="modevlib/Bugzilla.js"></script>
	<script type="text/javascript" src="modevlib/math/Stats.js"></script>
	<script type="text/javascript" src="modevlib/ScrumBugs.js"></script>
	<script type="text/javascript" src="modevlib/qb/MVEL.js"></script>
	<script type="text/javascript" src="lib/ccc/def/def.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvc.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvc.text.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvc.color.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvc.trends.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvc.options.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/_data.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/meta/DimensionType.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/meta/ComplexType.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/meta/ComplexTypeProject.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/TranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/MatrixTranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/CrosstabTranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/RelationalTranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Atom.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Complex.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/ComplexView.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Datum.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Dimension.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Data.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Data.selected.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/GroupingSpec.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/DataOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/GroupingOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/LinearInterpolationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/LinearInterpolationOperSeriesState.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/ZeroInterpolationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/ZeroInterpolationOperSeriesState.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Data.operations.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/Data.compat.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Role.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Scene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Var.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/BasicSign.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Sign.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Panel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Label.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Dot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Line.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Area.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Bar.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/PieSlice.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/sign/Rule.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Context.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/OptionsBase.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Axis.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxis.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxisRootScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianAxisTickScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/CartesianFocusWindow.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/ColorAxis.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/SizeAxis.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/Legend.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletRootScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletGroupScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemSceneSelection.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemSceneVisibility.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemRenderer.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/BulletItemDefaultRenderer.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/Plot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/CartesianPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/CategoricalPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BarPlotAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BarPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/NormalizedBarPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/WaterfallPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/PointPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/MetricXYPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/MetricPointPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/PiePlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/HeatGridPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BoxPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/plot/BulletPlot.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.visualRoles.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.data.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.plots.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.axes.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.panels.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.selection.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBaseChart.extension.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBasePanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPlotPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcMultiChartPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcTitlePanelAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcTitlePanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcLegendPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcGridDockingPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianGridDockingPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcCartesianAbstractPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPlotBgPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcCategoricalAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcCategoricalAbstractPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcAxisPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcAxisTitlePanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPiePanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPieChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBarAbstractPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBarAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBarPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBarChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcNormalizedBarPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcNormalizedBarChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/visual/legend/WaterfallBulletGroupScene.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcWaterfallPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcWaterfallChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPointPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcPoint.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcHeatGridPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcHeatGridChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcMetricXYAbstract.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/MetricPointChartTranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcMetricPointPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcMetricPoint.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBulletChart.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcParallelCoordinates.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcDataTree.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/data/translation/BoxplotChartTranslationOper.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBoxplotPanel.js"></script>
	<script type="text/javascript" src="lib/ccc/pvc/pvcBoxplotChart.js"></script>
	<script type="text/javascript" src="lib/ccc/data/q01-01.js"></script>
	<script type="text/javascript" src="modevlib/main.js"></script>
	<script type="text/javascript" src="modevlib/Dimension.js"></script>
	<script type="text/javascript" src="modevlib/charts/aColor.js"></script>
	<script type="text/javascript" src="modevlib/qb/ESQuery.js"></script>
	<script type="text/javascript" src="modevlib/gui/GUI.js"></script>
	<script type="text/javascript" src="modevlib/charts/aChart.js"></script>
	<script type="text/javascript" src="modevlib/Hierarchy.js"></script>
	<script type="text/javascript" src="modevlib/Dimension-Bugzilla.js"></script>
	<link type="text/css" rel="stylesheet" href="css/menu.css"/>
	<script type="text/javascript" src="modevlib/Dimension-B2G.js"></script>
	<script type="text/javascript" src="modevlib/gui/ProductFilter.js"></script>
	<script type="text/javascript" src="modevlib/Dimension-Features.js"></script>

	<script type="text/javascript" src="js/burndown.js"></script>
	<script type="text/javascript" src="lib/sorttable/sorttable.js"></script>


	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49796218-5', 'mozilla.org');
  ga('send', 'pageview');
	</script>

</HEAD>
<BODY>



<div id="sidebar" style="width:300px;">
	<br><br>
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
	<hr>
	<div id="description">
		Simple burndown chart by sprint or milestone.<br><br>
		The chart requires a milestone be selected.  Filtering by Team is
		optional.<br><br>
		This dashboard makes no attempt at predicting bug close rate; there is not enough
		information in any one (or few) milestones to get reasonable estimates.
		However, a simple grey line is provided that shows an ideal burndown
		from the current remaining work down to zero at end of the milestone.
		Use it as you see fit.<br><br>
		The new/closed bugs per day statistic includes all the bugs added to
		the milestone at the beginning, and removed at the end (provided it
		happens inside the time window).  If you are viewing multiple
		milestones the number may be artificially large.
	</div>


</div>

<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title">Milestone Burndown</h3>

	<div>
		<div id="milestone-summary" style="min-height: 30px; position: relative;"></div>
		<div id="chart" class="chart" style="position: relative;height:300px;"></div>
		<div id="chart_diff" class="chart" style="position: relative;height:300px;"></div>
		<div id="buglist" style="position: relative;width:800px"></div>
		<div id="info" style="position: relative;width:800px"></div>
		<div id="report"></div>
	</div>
</div>
<script type="application/javascript">
var color = {
	"blue":"#1f77b4",
	"orange":"#ff7f0e",
	"green":"#2ca02c",
	"red":"#d62728",
	"purple":"#9467bd",
	"brown":"#8c564b",
	"cyan":"#17becf"
};


importScript([
	"modevlib/main.js",
	"modevlib/gui/dynamic.js",
	'modevlib/Dimension-Bugzilla.js',
	'modevlib/Dimension-B2G.js',
	'modevlib/Dimension-Features.js',
	"js/burndown.js",
	"lib/sorttable/sorttable.js"
], function(){




var thread;
var createChart = function(){
	if (thread !== undefined)
		thread.kill();
	thread = Thread.run(function*(){
		try{
			yield (__createChart());
		}catch(e){
			if (e.contains(Thread.Interrupted)) return;
			throw e;
		}//try
	});
};

var __createChart = function*(){
	var NOW = Date.now();
	var TODAY = Date.today();

	$("#milestone-summary").html("");
	$("#chart").html("");
	$("#chart_diff").html("");
	$("#buglist").html("");

	var teamName = GUI.state.team.getSelectedParts().select("name").join(" and ");
	var teamFilter = GUI.state.team.makeFilter();
	if (teamName==""){
		teamName = "All Teams";
		teamFilter = Mozilla.B2G.esfilter;
	}//endif

	var milestones = GUI.state.milestone.getSelectedParts();
	var milestoneName;
	if (milestones.length==0){
		$("#title").text("Must select a milestone");
		yield (null)
	}//endif

	milestoneName=milestones.map(function(m){return m.name;}).join(" and ");
	var START_DATE=null;
	var DUE_DATE=null;
	milestones.forall(function(m){
		START_DATE = Date.min(START_DATE, Date.newInstance(m.start_date));
		DUE_DATE = Date.max(DUE_DATE, Date.newInstance(m.targetDate).add(Duration.DAY));
		MIN_CHART_DATE = Date.min(START_DATE, TODAY.subtract(Duration.newInstance("2week")));
		MAX_CHART_DATE=DUE_DATE.addDay(1);
	});
	var MIN_CHART_DATE = Date.min(START_DATE, TODAY.subtract(Duration.newInstance("2week")));
	var MAX_CHART_DATE=DUE_DATE.addDay(1);

	var sampleInterval = Duration.DAY;
	var timeDomain = {"type":"time", "min":MIN_CHART_DATE, "max":MAX_CHART_DATE, "interval":sampleInterval};



	if (title && title.length>0){
		$("#title").text(title);
	}else{
		$("#title").text("Burndown for "+teamName)
	}//endif

	yield (ESQuery.loadColumns({"from":"bugs"}));

	var mainFilter = {"and":[
		{"and":[
			{"range":{"modified_ts":{"lt":MAX_CHART_DATE.getMilli()}}},
			{"range":{"expires_on":{"gte":MIN_CHART_DATE.getMilli()}}}
		]},
//		{"script":{"script":MVEL.compile.expression("floorInterval(modified_ts-" + sampleMin.getMilli() + ", " + sampleInterval.milli + ")!=floorInterval(expires_on-" + sampleMin.getMilli() + ", " + sampleInterval.milli + ")", {"from":"bugs"})}},
		GUI.getFilters("bugs")
	]};



	Thread.run(function*(){
		////////////////////////////////////////////////////////////////////////////
		// CURRENT BUGS LIST
		////////////////////////////////////////////////////////////////////////////

		var bugs = yield (ESQuery.run({
			"from":"public_bugs",
			"select":[
				"bug_id",
				"short_desc",
				"assigned_to",
				"bug_status",
				"resolution",
				"status_whiteboard",
				"priority"
			],
			"esfilter":{"and":[
				Mozilla.CurrentRecords.esfilter,
				GUI.state.milestone.makeFilter(),
				teamFilter
			]}
		}));

		var details = yield (Qb.calc2List({
			"from":bugs,
			"select":[
				{"name":"bug_id", "value":"bug_id"},
				{"name":"Summary", "value":"short_desc"},
				{"name":"Owner", "value":"assigned_to"},
				{"name":"Status", "value":"bug_status + (resolution ? ' - '+resolution : '')"},
				{"name":"Estimate", "value":"nvl(ScrumBugs.parse(status_whiteboard).points, 'missing')"},
				{"name":"Priority", "value":"priority"}
			],
			"sort":["Status", "bug_id"]
		}));

		var table = $("#buglist").html(bugDetails(details.list)).find("table")[0];
		sorttable.makeSortable(table);
	});

	var churnTimeDomain={"type":"time", "min":MIN_CHART_DATE, "max":DUE_DATE, "interval":Duration.DAY, "value":"value"};

	var perDay;
	var churnThread=Thread.run(function*(){
		////////////////////////////////////////////////////////////////////////////
		// DAILY CHANGE
		////////////////////////////////////////////////////////////////////////////
		var a = Log.action("Request Churn", true);
		var minMaxBugs=yield(ElasticSearch.getOpenMinMax(teamFilter, churnTimeDomain, ["status_whiteboard", "cf_blocking_loop", "cf_blocking_b2g", "target_milestone", "keywords", "resolution"]));

		var diff = yield(Q({
			"from":minMaxBugs,
			"select":[
				{"name":"opened", "value":"(time.min.getMilli()<=min && min<time.max.getMilli()) ? 1 : 0", "aggregate":"sum", "default":0, "style":{"color":Color.BLUE.multiply(0.9).hue(10).toHTML()}},
				{"name":"closed", "value":"(time.min.getMilli()<=max && max<time.max.getMilli()) ? 1 : 0", "aggregate":"sum", "default":0, "style":{"color":Color.RED.multiply(0.9).hue(10).toHTML()}}
			],
			"edges":[
				{"name":"type", "domain":Mozilla.ChurnType.getDomain()},
				{"name":"date", "test":"(time.min.getMilli()<=min && min<time.max.getMilli()) || (time.min.getMilli()<=max && max<time.max.getMilli())",
					"allowNulls":false,
					"domain":Map.copy(churnTimeDomain)
				}
			]
		}));

		var chart=yield(Q({
			"from":diff,
			"select":[
				{"name":"Opened", "value":"opened", "aggregate":"sum", "style":{"color":color.blue}},
				{"name":"Other", "value":"type.name=='Other' ? -closed : 0", "aggregate":"sum", "style":{"color":"lightgray"}},
				{"name":"Dups", "value":"type.name=='Dups' ? -closed : 0", "aggregate":"sum", "style":{"color":"gray"}},
				{"name":"Targeted", "value":"type.name=='Targeted' ? -closed : 0", "aggregate":"sum", "style":{"color":color.green}},
				{"name":"Blocker", "value":"type.name=='Blocker' ? -closed : 0", "aggregate":"sum", "style":{"color":color.orange}},
				{"name":"Regression", "value":"type.name=='Regression' ? -closed : 0", "aggregate":"sum", "style":{"color":color.red}}
			],
			"edges":[
				{"name":"date", "value":"date", "domain":Map.copy(churnTimeDomain)}
			]
		}));
		Log.actionDone(a);

		a = Log.action("Make chart", true);
		aChart.show({
			"name":"Bug Churn",
			"id":"chart_diff",
			"sheetDiv":"info",
			"type":"bar",
			"stacked":true,
			"cube":chart,
			"xAxisSize":50,
			"clickAction":function(series, x, d){
				Thread.run(function*(){
					var where = {"and":[]};
					if (series=="Opened"){
						where.and.append({"range":{"min":{"gte": x.getMilli()}}});
						where.and.append({"range":{"min":{"lt": x.addDay().getMilli()}}});
					}else{
						where.and.append({"range":{"max":{"gte": x.getMilli()}}});
						where.and.append({"range":{"max":{"lt": x.addDay().getMilli()}}});
						where.and.append(Mozilla.ChurnType[series].fullFilter);
					}//endif

					var buglist=minMaxBugs.list.filter(where);
					Bugzilla.showBugs(buglist.select("bug_id"));
				});
			}//click
		});
		Log.actionDone(a);

		perDay = (yield(Qb.calc2List({
			"from":diff,
			"select":[
				{"name":"opened", "value":"opened", "aggregate":"sum"},
				{"name":"closed", "value":"closed", "aggregate":"sum"}
			],
			"where":START_DATE.getMilli()+"<=date.getMilli() && date.getMilli()<"+Date.min(DUE_DATE, TODAY).getMilli()
		}))).list[0];

		var daysInSprint=Date.diffWeekday(Date.min(DUE_DATE, TODAY), START_DATE);


		$("#stats").html(
			'<span class="parameter_name">Workdays in milestone:</span>' + daysInSprint + '<br>' +
			'<span class="parameter_name">New bugs per day:</span>' + aMath.round(perDay.opened/daysInSprint, 1) + '<br>' +
			'<span class="parameter_name">Closed per day:</span>' + aMath.round(perDay.closed/daysInSprint, 1) + '<br>' +
			''
		);

	});


	var currMilestoneThread=Thread.run(function*(){
		///////////////////////////////////////////////////////////////////////
		// SUMMARY OF MILESTONE
		///////////////////////////////////////////////////////////////////////
		var a = Log.action("get summary", true);
		var currMilestone=yield (ESQuery.run({
			"from":"bugs",
			"select":[
				"bug_id",
				"bug_status",
				"status_whiteboard",
				"target_milestone",
				"cf_blocking_loop",
				"cf_blocking_b2g",
				"keywords",
				"modified_ts",
				"expires_on"
			],
			"esfilter":{"and":[
				{"or":milestones.map(function(m){ //ONLY RECORDS FOR THE TARGET DATES
					var due = Date.newInstance(m.targetDate).floorDay().addDay().getMilli();
					return {"and":[
						{"range":{"modified_ts":{"lte":due}}},
						{"range":{"expires_on":{"gt":due}}}
					]};
				})},
				GUI.state.milestone.makeFilter(),
				teamFilter
			]}
		}));
		Log.actionDone(a);

		a = Log.action("calc summary", true);
		var milestoneTotals=yield(Q({
			"from":currMilestone,
			"select":[
				{"name":"work",  "value":'nvl(ScrumBugs.parse(status_whiteboard).points, 1)-0', "aggregate":"sum", "default":0},
				{"name":"count",  "value":'1', "aggregate":"sum", "default":0}
			],
			"edges":[
				{"name":"Milestone", "domain":Mozilla.Milestone.getDomain()},
				{"name":"type", "domain":Mozilla.CountType.getDomain()}
			],
			"where":"modified_ts <= Date.newInstance(Milestone.targetDate).floorDay().addDay().getMilli() && Date.newInstance(Milestone.targetDate).floorDay().addDay().getMilli() < expires_on"
		}));

		//FILL TEMPLATE
		var summary=$("#milestone-summary");
		summary.html(
			milestones.map(function(m){
				var i=milestoneTotals.edges[0].domain.getPartByKey(m.name).dataIndex;
				var total=aMath.SUM( milestoneTotals.cube[i].select("count"));
				Mozilla.Milestone[m.name].total=total;

				var work=aMath.SUM( milestoneTotals.cube[i].select("work"));
				var count=aMath.SUM( milestoneTotals.cube[i].select("count"));
				Mozilla.Milestone[m.name].work=work;
				Mozilla.Milestone[m.name].count=count;

				var TEMPLATE = new Template("<div>" +
						"<div style='width:251px;display: inline-block;padding:0px 10px 0px 10px'>Milestone {{milestone}} (end of {{date}}):</div>" +
						"<div id='{{milestone}}Total' class='hoverable' style='width:75px;display:inline-block;'>Total: {{total}}</div>"+
						"<div id='{{milestone}}Closed' class='hoverable' style='width:125px;display:inline-block;'>Closed: {{closed}} ({{closed_percent}}%)</div>"+
						"<div id='{{milestone}}Open' class='hoverable' style='display:inline-block;'>Open Bugs: {{open}}</div>" +
						" (<div id='{{milestone}}Regressions' class='hoverable' style='display:inline-block;'>{{regressions}} regressions</div>)"+
						"</div");
				return TEMPLATE.replace({
					"milestone": m.name,
					"date": DUE_DATE <= TODAY ? DUE_DATE.subtract(Duration.DAY).format("NNN dd") : "today",
					"total": total,
					"open": nvl(milestoneTotals.cube[i][1].count, 0) + nvl(milestoneTotals.cube[i][0].count, 0),
					"regressions": nvl(milestoneTotals.cube[i][0].count, "0"),
					"closed": milestoneTotals.cube[i][2].count,
					"closed_percent": aMath.round(milestoneTotals.cube[i][2].count / total * 100)
				});
			})
		);
		Log.actionDone(a);

		//ADD BUG CLICKERS
		milestones.forall(function(m){
			var i=milestoneTotals.edges[0].domain.getPartByKey(m.name).dataIndex;

			var totalButton = $("#"+  CNV.String2JQuery(m.name+"Total"));
			totalButton.click(function(){
				Thread.run(function*(){
					var buglist=(yield (ESQuery.run({
						"from":"bugs",
						"select":{"value":"bug_id", "aggregate":"minimum"},
						"edges":[
							{"name":"unique", "value":"bug_id"}
						],
						"esfilter":{"and":[
							Mozilla.CurrentRecords.esfilter,
							GUI.state.milestone.makeFilter(),
							teamFilter
						]}
					})));

					Bugzilla.showBugs(buglist.cube);
				});
			});

			milestoneTotals.edges[1].domain.partitions.forall(function(t, i){
				$("#"+ CNV.String2JQuery(m.name+ t.name)).click(function(){
					Thread.run(function*(){
						var buglist=(yield (ESQuery.run({
							"from":"bugs",
							"select":{"value":"bug_id", "aggregate":"minimum"},
							"edges":[
								{"name":"unique", "value":"bug_id"}
							],
							"esfilter":{"and":[
								Mozilla.CurrentRecords.esfilter,
								t.esfilter,
								GUI.state.milestone.makeFilter(),
								teamFilter
							]}
						})));

						Bugzilla.showBugs(buglist.cube);
					});
				});
			});
		});
	});

	///////////////////////////////////////////////////////////////////////
	// BURNDOWN
	///////////////////////////////////////////////////////////////////////
	var chart;
	var a = Log.action("Request Bugs", true);
	var milestoneBugs=yield(ESQuery.run({
		"from":"bugs",
		"select":[
			"bug_id",
			"bug_status",
			"status_whiteboard",
			"keywords",
			"modified_ts",
			"expires_on"
		],
		"esfilter":{"and":[
			GUI.state.milestone.makeFilter(),
			teamFilter,
			{"range":{"modified_ts":{"lt":MAX_CHART_DATE.getMilli()}}},
			{"range":{"expires_on":{"gte":MIN_CHART_DATE.getMilli()}}}
		]}
	}));
	Log.actionDone(a);

	var a = Log.action("render history", true);
	chart = yield(Q({
		"from": milestoneBugs,
		"select":[
			{"name":"work", "value":'nvl(ScrumBugs.parse(status_whiteboard).points, 1)-0', "aggregate":"sum", "default":0},
			{"name":"count", "value":'bug_id', "aggregate":"count", "default":0}
		],
		"edges":[
			{"name": "status", "domain":Mozilla.CountType.getDomain()},
			{"name":"date",
				"range":{"min":"modified_ts", "max":"expires_on"},
				"allowNulls":false,
				"domain":timeDomain
			}
		]
	}));

	var flat = yield(Q({
		"from": chart,
		"select":[
			{"name":"Regressions", "value":"status.name=='Regressions' ? count : null", "aggregate":"sum", "default":0},
			{"name":"Open_Bugs", "value":"['Open', 'Regressions'].contains(status.name) ? count : null", "aggregate":"sum", "default":0},
			{"name":"Remaining_Work", "value":"['Open', 'Regressions'].contains(status.name) ? work : null", "aggregate":"sum", "default":0},
			{"name":"Total_Bugs", "value":"count", "aggregate":"sum", "default":0}
		],
		"edges":[
			{"name":"date", "value":"date",
				"allowNulls":false,
				"domain":timeDomain
			}
		]
	}));
	Log.actionDone(a);

	yield (currMilestoneThread.join());


	var tempTimeDomain=flat.edges[0].domain;

	//SHOW FUTURE VALUES AS NULLS
	flat.cube.forall(function(v, i){
		if (tempTimeDomain.partitions[i].min > TODAY.addDay()){
			flat.cube[i]=Map.zip(mapAllKey(v, function(k, v){
				return [k, null];
			}));
		}//endif
	});

	var stats = yield(Q({
		"from":flat,
		"select":[
			{"name":"closed", value:"Open_Bugs"},
			{"name":"total", value:"Total_Bugs"}
		],
		"edges":[
			{"name":"date", "value":"date",
				"allowNulls":false,
				"domain":timeDomain
			}
		]
	}));


	yield (Thread.join(churnThread));


	var stillOpen = 0;
	var stillWork = 0;
	var daysRemaining = 1;

	if (DUE_DATE <= TODAY){
		//DONE, NO STATS REQUIRED
	}else{
		var todayPart=flat.edges[0].domain.getPartByKey(TODAY);
		stillOpen = flat.cube[todayPart.dataIndex].Open_Bugs;
		stillWork = flat.cube[todayPart.dataIndex].Remaining_Work;
		daysRemaining=aMath.max(1, Date.diffWeekday(DUE_DATE, TODAY));

		var TEMPLATE=new Template(
			'<hr>'+
			'<span class="parameter_name">Days Remaining:</span>{{daysRemaining}}<br>'+
			'<span class="parameter_name">Required Closed/Day:</span>{{count}} ({{work}} points)<br>'
		);

		$("#stats").append(TEMPLATE.replace({
			"daysRemaining":daysRemaining,
			"count":aMath.round(stillOpen / daysRemaining, 1),
			"work":aMath.round(stillWork / daysRemaining, 1)
		}));
	}//endif




	//WE WILL CHART A DYNAMIC SET OF COLUMNS, BASED ON IF WE ARE LOOKING AT A FUTURE OR PAST DUE DATE
	var columnsToChart=[
//		{"name":"Total Bugs", "value":"Total_Bugs", "style":{"color":color.cyan, "visibility":"hidden"}},
		{"name":"Remaining Work", "value":"Remaining_Work", "style":{"color":color.orange}},
		{"name":"Open Bug Count", "value":"Open_Bugs", "style":{"color":color.blue}},
		{"name":"Regressions", "value":"Regressions", "style":{"color":color.red}}
	];

//	var slopes=[];
//	milestones.forall(function(m, i){
//		var ms = Mozilla.Milestone[m.name];
//		var work = ms.work;
//		var start_date=Date.newInstance(ms.start_date);
//		var targetDate=Date.newInstance(ms.targetDate);
//		var duration = Date.diffWeekday(targetDate, start_date);
//		var slope=function(date){
//			if (date <= start_date) {
//				return work;
//			} else if (date >= targetDate) {
//				return 0;
//			} else {
//				return work - (work * Date.diffWeekday(date, start_date) / duration);
//			}//endif
//		};
//		slopes.append(slope);
//	});
	var ideal=function(date){
		if (date>DUE_DATE){
			return 0;
		}else{
			return aMath.round(stillWork - (stillWork * Date.diffWeekday(date, TODAY) / daysRemaining));
		}//endif
	};

	//IDEAL BURNDOWN
	aChart.addPredictionLine({
		"source":{
			"name":"Remaining_Work",
			"domain":{"min":MIN_CHART_DATE, "max":MAX_CHART_DATE},
			"data":flat.list
		},
		"predict":{
			"name":"ideal",
			"domain":{"min":TODAY, "max":MAX_CHART_DATE},
			"line": ideal
		}
	});

	columnsToChart.insert(0, {"name":"Required Burndown", "value":"ideal", "style":{"color":"lightgray"}});
	flat.select.push({"name":"ideal"});
	flat.columns.push({"name":"ideal"});

	var chartP = yield(Q({
		"from":flat,
		"select": columnsToChart,
		"edges":[
			{"name":"date", "value":"date", "domain":timeDomain}
		]
	}));


	a = Log.action("Make chart", true);
	aChart.show({
		"id":"chart",
		"sheetDiv":"info",
		"type":"line",
		"stacked":false,
		"cube":chartP,
		"xAxisSize":50,
		extensionPoints: {
		    dot_shapeRadius: 3,
            dot_shape:"circle",
			line_lineWidth: 3
		},
		"clickAction":function(series, x, d){
			//MAP FROM HUMANE NAMES BACK TO ORIGINAL DIMENSION DEFINITION NAME
			series = {"Open Bug Count": "Open", "Remaining Work": "Open", "Regressions": "Regressions"}[series];

			Thread.run(function*(){
				try{
					var buglist=(yield (ESQuery.run({
						"from":"bugs",
						"select":{"value":"bug_id", "aggregate":"minimum"},
						"edges":[
							{"name":"unique", "value":"bug_id"}
						],
						"esfilter":{"and":[
							mainFilter,
							{"range":{"modified_ts":{"lte":x.getMilli()}}},
							{"range":{"expires_on":{"gt":x.getMilli()}}},
							GUI.state.milestone.makeFilter(),
							teamFilter,
							series=="Total" ? ESQuery.TrueFilter :Mozilla.CountType[series].esfilter
						]}
					})));

					Bugzilla.showBugs(buglist.cube);
				}catch(e){
					Log.warning("thread failure", e);
					yield(null);  //SILENT FAILURE
				}
			});
		}//click
	});
	Log.actionDone(a);

};


$(document).ready(function(){
	GUI.setup(createChart, [
		{"id": "team", "name": "Team", "type": PartitionFilter.newInstance({
			"id": "teams",
			"name": "All Teams",
			"dimension": Mozilla.B2G.Team,
			"onlyOne": false,
			"expandAll": true,
			"treeDepth":1
		})},
		{"id": "milestone", "name": "Milestone", "type": PartitionFilter.newInstance({
			"id": "milestones",
			"name": "All Milestones",
			"dimension": Mozilla.Milestone,
			"onlyOne": false,
			"expandAll": true,
			"treeDepth":0
		})}
		],
		[],
		"bugs",
		false
	);

//	GUI.productFilter = ["B2G 1.0.0 (TEF)"];

});

});
</script>



</BODY>
</HTML>

